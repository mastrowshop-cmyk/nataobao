<script>
    // 1. ЗАМЕНИ НА СВОЮ ССЫЛКУ С RENDER
    const API_URL = "https://твой-проект.onrender.com"; 

    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    let myUser = null;

    async function init() {
        if (!tg.initDataUnsafe.user) return alert("Зайди через бота!");

        try {
            const res = await fetch(`${API_URL}/api/auth`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(tg.initDataUnsafe.user)
            });
            myUser = await res.json();

            document.getElementById('user-name').innerText = myUser.full_name;
            document.getElementById('personal-code').innerText = myUser.personal_code;

            // Показ вкладок по ролям
            if (myUser.role === 'admin') {
                document.getElementById('admin-btn').classList.remove('d-none');
                document.getElementById('operator-btn').classList.remove('d-none');
                // Добавляем форму управления пользователями в админку
                addAdminPanel(); 
            } else if (myUser.role === 'operator') {
                document.getElementById('operator-btn').classList.remove('d-none');
            }

            loadPackages();
        } catch (e) { alert("Ошибка сервера Render"); }
    }

    // Кнопка назначения ролей
    function addAdminPanel() {
        const adminTab = document.getElementById('admin');
        const managementHtml = `
            <div class="card mt-4 p-3 bg-dark text-white">
                <h6>Управление ролями</h6>
                <input type="number" id="target-id" class="form-control mb-2" placeholder="Telegram ID">
                <select id="target-role" class="form-select mb-2">
                    <option value="operator">Оператор</option>
                    <option value="admin">Админ</option>
                    <option value="user">Удалить (User)</option>
                </select>
                <button class="btn btn-warning w-100" onclick="updateRole()">Назначить</button>
            </div>`;
        adminTab.insertAdjacentHTML('beforeend', managementHtml);
    }

    async function updateRole() {
        const tid = document.getElementById('target-id').value;
        const role = document.getElementById('target-role').value;
        const res = await fetch(`${API_URL}/api/admin/manage_user`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({admin_id: myUser.tg_id, target_id: tid, role: role})
        });
        const out = await res.json();
        alert(out.message);
    }

    // Твои функции интерфейса
    function openTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        toggleSidebar();
    }
    function toggleSidebar() {
        const sb = document.getElementById("sidebar");
        sb.style.width = sb.style.width === "250px" ? "0" : "250px";
    }

    async function loadPackages() {
        const res = await fetch(`${API_URL}/api/packages/${myUser.tg_id}`);
        const data = await res.json();
        document.getElementById('package-list').innerHTML = data.map(p => `
            <div class="package-card">${p.tracking_number} - ${p.status}</div>
        `).join('');
    }

    init();
</script>
