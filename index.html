<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --tg-theme-bg-color: #fff;
            --tg-theme-text-color: #000;
            --tg-theme-button-color: #3390ec;
            --tg-theme-button-text-color: #fff;
        }
        body {
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            padding-bottom: 80px;
        }
        .sidebar {
            height: 100%;
            width: 0;
            position: fixed;
            z-index: 1000;
            top: 0;
            left: 0;
            background-color: #1c1c1e;
            overflow-x: hidden;
            transition: 0.3s;
            padding-top: 60px;
        }
        .sidebar a {
            padding: 10px 15px;
            text-decoration: none;
            font-size: 18px;
            color: #818181;
            display: block;
            transition: 0.3s;
        }
        .sidebar a:hover { color: #f1f1f1; }
        .openbtn {
            font-size: 20px;
            cursor: pointer;
            background-color: transparent;
            color: var(--tg-theme-text-color);
            padding: 10px 15px;
            border: none;
        }
        .card-custom {
            background-color: rgba(128, 128, 128, 0.1);
            border: none;
            border-radius: 12px;
            margin-bottom: 10px;
        }
        .status-badge {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        /* –°–∫—Ä—ã—Ç–∏–µ —Å–µ–∫—Ü–∏–π */
        .section { display: none; padding: 15px; }
        .active-section { display: block; }
    </style>
</head>
<body>

    <div class="d-flex align-items-center border-bottom p-2">
        <button class="openbtn" onclick="toggleNav()">‚ò∞</button>
        <span class="ms-2 fw-bold">China Logistics üá®üá≥üá∑üá∫</span>
    </div>

    <div id="mySidebar" class="sidebar">
        <a href="javascript:void(0)" class="closebtn" onclick="toggleNav()">√ó –ó–∞–∫—Ä—ã—Ç—å</a>
        <a href="#" onclick="showSection('profile')">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a>
        <a href="#" onclick="showSection('deliveries')">üì¶ –ú–æ–∏ –¥–æ—Å—Ç–∞–≤–∫–∏</a>
        <a href="https://t.me/telegram" target="_blank">üí¨ –ü–æ–¥–¥–µ—Ä–∂–∫–∞</a>
        
        <div id="operator-menu" style="display:none;">
            <hr class="text-white">
            <p class="text-white ps-3 small">–û–ü–ï–†–ê–¢–û–†</p>
            <a href="#" onclick="showSection('weighing')">‚öñÔ∏è –í–∑–≤–µ—Å–∏—Ç—å</a>
        </div>

        <div id="admin-menu" style="display:none;">
            <hr class="text-white">
            <p class="text-white ps-3 small">–ê–î–ú–ò–ù</p>
            <a href="#" onclick="showSection('admin-settings')">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–ø–ª–∞—Ç—ã</a>
        </div>
    </div>

    <div id="profile" class="section active-section">
        <h3>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h3>
        <div class="card-custom p-3">
            <p><strong>–ö–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞:</strong> <span id="user-pcode" class="text-primary fw-bold">–ó–∞–≥—Ä—É–∑–∫–∞...</span></p>
            <div class="mb-3">
                <label class="form-label">–í–∞—à–µ –ò–º—è</label>
                <input type="text" class="form-control" id="profile-name">
            </div>
            <button class="btn btn-primary w-100" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>

    <div id="deliveries" class="section">
        <h3>–ú–æ–∏ –ø–æ—Å—ã–ª–∫–∏</h3>
        <div id="packages-list">
            </div>
    </div>

    <div id="weighing" class="section">
        <h3>–í–∑–≤–µ—à–∏–≤–∞–Ω–∏–µ</h3>
        <div class="card-custom p-3">
            <div class="mb-3">
                <label>–ö–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä USER-1001)</label>
                <input type="text" class="form-control" id="op-user-code">
            </div>
            <div class="mb-3">
                <label>–í–µ—Å (–∫–≥)</label>
                <input type="number" class="form-control" id="op-weight" step="0.1">
            </div>
            <button class="btn btn-success w-100" onclick="submitWeight()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∏ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <div id="weigh-result" class="mt-3 text-success"></div>
        </div>
    </div>

    <div id="admin-settings" class="section">
        <h3>–¢–µ–∫—Å—Ç –¥–ª—è –æ–ø–ª–∞—Ç—ã</h3>
        <textarea class="form-control mb-3" id="admin-payment-text" rows="5"></textarea>
        <button class="btn btn-warning w-100" onclick="savePaymentText()">–û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentUser = null;
        const API_URL = ""; // –ü—É—Å—Ç–æ–π, —Ç–∞–∫ –∫–∞–∫ –Ω–∞ –æ–¥–Ω–æ–º –¥–æ–º–µ–Ω–µ

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener("DOMContentLoaded", async () => {
            const user = tg.initDataUnsafe.user;
            if (user) {
                // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–∞ –±—ç–∫–µ
                const response = await fetch('/api/auth', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(user)
                });
                currentUser = await response.json();
                
                // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
                document.getElementById('user-pcode').innerText = currentUser.personal_code;
                document.getElementById('profile-name').value = currentUser.full_name;

                // –†–æ–ª–µ–≤–∞—è –º–æ–¥–µ–ª—å
                if (currentUser.role === 'operator' || currentUser.role === 'admin') {
                    document.getElementById('operator-menu').style.display = 'block';
                }
                if (currentUser.role === 'admin') {
                    document.getElementById('admin-menu').style.display = 'block';
                    loadAdminData();
                }

                loadPackages();
            } else {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram");
            }
        });

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        function toggleNav() {
            const sb = document.getElementById("mySidebar");
            sb.style.width = sb.style.width === "250px" ? "0" : "250px";
        }

        function showSection(id) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active-section'));
            document.getElementById(id).classList.add('active-section');
            toggleNav();
        }

        // –§—É–Ω–∫—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞
        async function saveProfile() {
            const newName = document.getElementById('profile-name').value;
            await fetch('/api/profile/update', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({tg_id: currentUser.tg_id, full_name: newName})
            });
            alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
        }

        async function loadPackages() {
            const res = await fetch(`/api/packages/${currentUser.tg_id}`);
            const data = await res.json();
            const list = document.getElementById('packages-list');
            list.innerHTML = '';
            
            data.forEach(pkg => {
                const el = document.createElement('div');
                el.className = 'card-custom p-3 d-flex justify-content-between align-items-center';
                el.innerHTML = `
                    <div>
                        <div class="fw-bold">${pkg.tracking_number}</div>
                        <div class="small text-muted">${pkg.location} ‚Ä¢ ${pkg.weight} –∫–≥</div>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold text-success">${pkg.cost} —Ä—É–±</div>
                        <span class="status-badge">${pkg.status}</span>
                    </div>
                `;
                list.appendChild(el);
            });
        }

        // –§—É–Ω–∫—Ü–∏–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
        async function submitWeight() {
            const userCode = document.getElementById('op-user-code').value;
            const weight = parseFloat(document.getElementById('op-weight').value);
            
            const res = await fetch('/api/operator/weigh', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({user_code: userCode, weight: weight})
            });
            const data = await res.json();
            
            document.getElementById('weigh-result').innerText = `–ì–æ—Ç–æ–≤–æ! –°—Ç–æ–∏–º–æ—Å—Ç—å: ${data.cost} —Ä—É–±`;
        }

        // –§—É–Ω–∫—Ü–∏–∏ –∞–¥–º–∏–Ω–∞
        async function loadAdminData() {
            const res = await fetch('/api/admin/payment');
            const data = await res.json();
            document.getElementById('admin-payment-text').value = data.text;
        }

        async function savePaymentText() {
            const text = document.getElementById('admin-payment-text').value;
            await fetch('/api/admin/payment', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({text: text})
            });
            alert('–¢–µ–∫—Å—Ç –æ–ø–ª–∞—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω!');
        }
    </script>
</body>
</html>